<!--
@license
Copyright (c) 2017 Vaadin Ltd.
This program is available under Apache License Version 2.0, available at https://vaadin.com/license/
-->

<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../vaadin-themable-mixin/vaadin-themable-mixin.html">
<link rel="import" href="../vaadin-control-state-mixin/vaadin-control-state-mixin.html">
<link rel="import" href="vaadin-form-element-mixin.html">

<dom-module id="such-textarea-default-theme" theme-for="such-textarea-field">
    <template>
        <style>
            [part="label"] {
                font-size: 0.875em;
                font-weight: 600;
                margin-bottom: 0.25em;
            }

            [part="input-field"] {
                padding: 0.25em;
            }

            :host([focused]) [part="input-field"] {
            }

            :host([invalid]) [part="input-field"] {
                border-color: red;
            }

            :host([disabled]) {
                opacity: 0.5;
            }

            [part="value"] {
                border: 0;
                background: transparent;
                padding: 0;
                margin: 0;
                font: inherit;
                outline: none;
                box-shadow: none;
            }

            [part="error-message"] {
                font-size: 0.875em;
                margin-top: 0.25em;
                color: red;
            }


            :host {
                display: inline-block;
                width: 175px;
                outline: none;
                margin: 0;
                padding: 0;
                background: transparent;
            }

            .vaadin-text-field-container {
                display: flex;
                flex-direction: column;
                position: relative;
            }

            [part="label"]:empty {
                display: none;
            }

            [part="input-field"] {
                display: flex;
                align-items: center;
                margin-top: 4px;
                margin-bottom: 4px;
            }

            [part="value"] {
                width: 100%;
                box-sizing: border-box;
                flex: 1;
                min-width: 0;
            }

                [part="value"]::-ms-clear {
                    display: none;
                }

            :host {
                color: var(--valo-body-text-color);
                font-size: var(--valo-font-size, var(--valo-font-size-m));
                font-family: var(--valo-font-family);
                width: var(--valo-text-field-default-width, calc(var(--valo-size-m) * 5));
                -webkit-font-smoothing: antialiased;
                -moz-osx-font-smoothing: grayscale;
                -webkit-tap-highlight-color: transparent;
                width: 100%;
            }

            [part="label"] {
                color: var(--valo-contrast-60pct);
                font-weight: 500;
                font-size: var(--valo-font-size-s);
                margin-left: calc(var(--valo-text-field-border-radius, var(--valo-border-radius)) / 4);
                margin-bottom: var(--valo-space-xs);
                transition: color 0.4s;
                line-height: 1;
            }

            :host([label]) {
                margin-top: 0px;
                vertical-align: var(---vaadin-text-field-vertical-align-offset);
            }

            :host([focused]:not([readonly])) [part="label"] {
                color: var(--valo-primary-text-color);
            }

            [part="label"]::after {
                content: var(--valo-required-field-indicator, "â€¢");
                transition: all 0.2s;
                margin-left: 0.2em;
                opacity: 0;
                color: var(--valo-primary-text-color);
            }

            [part="value"] {
                -webkit-appearance: none;
                -moz-appearance: none;
                outline: none;
                margin: 0;
                border: 0;
                border-radius: 0;
                padding: 0 calc(var(--valo-size, var(--valo-size-m)) / 9);
                width: 100%;
                height: 100%;
                font-family: inherit;
                font-size: 12px;
                font-weight: 500;
                color: inherit;
                background-color: transparent;
                align-self: baseline;
                text-align: var(--valo-text-field-text-align);
                box-shadow: none;
            }

                [part="value"]::-webkit-input-placeholder {
                    color: var(--valo-tertiary-text-color);
                    transition: opacity 0.175s 0.05s;
                    opacity: 1;
                }

                [part="value"]:-ms-input-placeholder {
                    color: var(--valo-tertiary-text-color);
                }

                [part="value"]::-moz-placeholder {
                    color: var(--valo-tertiary-text-color);
                    transition: opacity 0.175s 0.05s;
                    opacity: 1;
                }

                [part="value"]::placeholder {
                    color: var(--valo-tertiary-text-color);
                    transition: opacity 0.175s 0.1s;
                    opacity: 1;
                }

            [part="input-field"] {
                border-radius: var(--valo-text-field-border-radius, var(--valo-border-radius));
                background-color: var(--valo-contrast-5pct);
                padding: 0 calc(var(--valo-size, var(--valo-size-m)) / 6 + var(--valo-text-field-border-radius, var(--valo-border-radius)) / 4);
                transition: all 0.5s;
                font-weight: 500;
                position: relative;
                will-change: transform;
                padding: 10px;
            }

            @media (hover: hover) {
                :host(:hover:not([readonly]):not([invalid]):not([focused])) [part="label"] {
                    color: var(--valo-body-text-color);
                }

                :host(:hover:not([readonly]):not([invalid]):not([focused])) [part="input-field"] {
                    background-color: var(--valo-contrast-10pct);
                }
            }

            :host([focused]:not([readonly])) [part="input-field"] {
                background-color: var(--valo-base-color);
                box-shadow: 0 0 0 1px var(--valo-contrast-10pct), 0 1px 4px 1px var(--valo-shade-10pct);
            }

            :host([focus-ring]) [part="input-field"] {
                transition-duration: 0.2s;
            }

            [part="input-field"]::after {
                content: "";
                position: absolute;
                top: -1px;
                right: -1px;
                bottom: -1px;
                left: -1px;
                border-radius: inherit;
                pointer-events: none;
                background-color: var(--valo-base-color);
                opacity: 0.5;
                transform: scaleX(0);
                transition: transform 0s, opacity 0s;
                transform-origin: 0 0;
                will-change: transform;
            }

            :host([focused]:not([focus-ring]):not([readonly])) [part="input-field"]::after {
                opacity: 0;
                transform: scaleX(1);
                transition: transform 0.15s, opacity 1s;
            }

            :host([disabled]) {
                pointer-events: none;
            }

                :host([disabled]) [part="value"] {
                    color: var(--valo-disabled-text-color);
                }

                    :host([disabled]) [part="value"]::-webkit-input-placeholder {
                        opacity: 0;
                    }

                    :host([disabled]) [part="value"]:-ms-input-placeholder {
                        opacity: 0;
                    }

                    :host([disabled]) [part="value"]::-moz-placeholder {
                        opacity: 0;
                    }

                    :host([disabled]) [part="value"]::placeholder {
                        opacity: 0;
                    }

                :host([disabled]) [part="input-field"] {
                    background-color: var(--valo-contrast-10pct);
                }

            :host([required]:not([has-value])) [part="label"]::after {
                opacity: 1;
            }

            :host([invalid]) [part="label"] {
                color: var(--valo-error-color);
            }

                :host([invalid]) [part="label"]::after {
                    color: inherit;
                }

            :host([invalid]) [part="input-field"] {
                background-color: var(--valo-error-color-10pct);
            }

            [part="error-message"] {
                margin-left: calc(var(--valo-text-field-border-radius, var(--valo-border-radius)) / 4);
                font-size: var(--valo-font-size-xs);
                line-height: var(--valo-line-height-xs);
                color: var(--valo-secondary-text-color);
                will-change: max-height;
                transition: 0.4s max-height;
                max-height: 5em;
            }

                [part="error-message"]::after {
                    content: "";
                    display: block;
                    height: var(--valo-space-s);
                }

                [part="error-message"][hidden] {
                    display: block;
                    max-height: 0;
                    overflow: hidden;
                }

            :host([theme~="small"]) {
                --valo-font-size: var(--valo-font-size-s);
                --valo-size: var(--valo-size-s);
            }

            :host([theme~="small"][label]) {
                ---vaadin-text-field-vertical-align-offset: 30px;
            }

                :host([theme~="small"][label]) [part="label"] {
                    font-size: var(--valo-font-size-xs);
                }

            [part="input-field"] ::slotted(vaadin-button) {
                margin: 0;
            }

            [part="input-field"] ::slotted(iron-icon[icon^="valo"]) {
                color: var(--valo-contrast-50pct);
            }
        </style>
    </template>
</dom-module>

<dom-module id="such-textarea">
    <template>
        <style>
            :host {
                display: inline-block;
                outline: none;
                margin-top: var(--valo-space-xs);
                margin-bottom: var(--valo-space-xs);
                border-radius: var(--valo-text-field-border-radius, var(--valo-border-radius));
                background-color: var(--valo-contrast-5pct);
                padding: 0 calc(var(--valo-size, var(--valo-size-m)) / 6 + var(--valo-text-field-border-radius, var(--valo-border-radius)) / 4);
                transition: all 0.5s;
                font-weight: 500;
                position: relative;
                will-change: transform;
            }


            .such-textarea-container {
                display: flex;
                flex-direction: column;
                position: relative;
            }

            [part="label"]:empty {
                display: none;
            }

            [part="input-field"] {
                display: flex;
                align-items: center;
            }

            [part="value"] {
                width: 100%;
                box-sizing: border-box;
                flex: 1;
                min-width: 0;
                resize: none;
            }

                [part="value"]::-ms-clear {
                    display: none;
                }
        </style>

        <div class="such-textarea-container">

            <label part="label" on-click="focus" id="[[_labelId]]">[[label]]</label>

            <div part="input-field">

                <slot name="prefix"></slot>


                <textarea rows="[[rows]]" cols="[[cols]]"
                          part="value"
                          autocomplete$="[[autocomplete]]"
                          autocorrect$="[[autocorrect]]"
                          autofocus$="[[autofocus]]"
                          disabled$="[[disabled]]"
                          list="[[list]]"
                          maxlength$="[[maxlength]]"
                          minlength$="[[minlength]]"
                          pattern="[[pattern]]"
                          placeholder="[[placeholder]]"
                          readonly$="[[readonly]]"
                          aria-readonly$="[[readonly]]"
                          required$="[[required]]"
                          aria-required$="[[required]]"
                          value="{{value::input}}"
                          title="[[title]]"
                          on-blur="validate"
                          on-input="_onInput"
                          aria-describedby$="[[_getActiveErrorId(invalid, errorMessage, _errorId)]]"
                          aria-labelledby$="[[_getActiveLabelId(label, _labelId)]]"
                          aria-invalid$="[[invalid]]"
                          type="[[type]]">
                </textarea>


                <slot name="suffix"></slot>

            </div>

            <div id="[[_errorId]]" aria-live="assertive" part="error-message" hidden$="[[!_getActiveErrorId(invalid, errorMessage, _errorId)]]">[[errorMessage]]</div>

        </div>

    </template>

    <script>
        (function () {
            /**
             * `<vaadin-text-field>` is a Polymer 2 element for text field control in forms.
             *
             * ```html
             * <vaadin-text-field label="First Name">
             * </vaadin-text-field>
             * ```
             *
             * ### Styling
             *
             * [Generic styling/theming documentation](https://cdn.vaadin.com/vaadin-valo-theme/0.3.1/demo/customization.html)
             *
             * The following shadow DOM parts are available for styling:
             *
             * Part name | Description
             * ----------------|----------------
             * `label` | The label element
             * `value` | The input element
             * `error-message` | The error message element
             * `input-field` | The element that wraps prefix, value and suffix
             *
             * The following state attributes are available for styling:
             *
             * Attribute    | Description | Part name
             * -------------|-------------|------------
             * `disabled` | Set to a disabled text field | :host
             * `has-value` | Set when the element has a value | :host
             * `invalid` | Set when the element is invalid | :host
             * `focused` | Set when the element is focused | :host
             * `focus-ring` | Set when the element is keyboard focused | :host
             *
             * @memberof Vaadin
             * @mixes Vaadin.ControlStateMixin
             * @mixes Vaadin.FormElementMixin
             * @mixes Vaadin.ThemableMixin
             * @demo demo/index.html
             */
            class TextFieldElement extends Vaadin.ControlStateMixin(Vaadin.FormElementMixin(Vaadin.ThemableMixin(Polymer.Element))) {
                static get is() {
                    return 'such-textarea';
                }

                static get properties() {
                    return {
                        /**
                         * Whether the value of the control can be automatically completed by the browser.
                         * List of available options at:
                         * https://developer.mozilla.org/en/docs/Web/HTML/Element/input#attr-autocomplete
                         */
                        autocomplete: {
                            type: String
                        },

                        /**
                         * This is a property supported by Safari that is used to control whether
                         * autocorrection should be enabled when the user is entering/editing the text.
                         * Possible values are:
                         * on: Enable autocorrection.
                         * off: Disable autocorrection.
                         */
                        autocorrect: {
                            type: String
                        },

                        /**
                         * Error to show when the input value is invalid.
                         */
                        errorMessage: {
                            type: String,
                            value: ''
                        },

                        /**
                         * String used for the label element.
                         */
                        label: {
                            type: String,
                            value: ''
                        },

                        /**
                         * Identifies a list of pre-defined options to suggest to the user.
                         * The value must be the id of a <datalist> element in the same document.
                         */
                        list: {
                            type: String
                        },

                        /**
                         * Maximum number of characters (in Unicode code points) that the user can enter.
                         */
                        maxlength: {
                            type: Number
                        },

                        /**
                         * Minimum number of characters (in Unicode code points) that the user can enter.
                         */
                        minlength: {
                            type: Number
                        },

                        /**
                         * The name of the control, which is submitted with the form data.
                         */
                        name: {
                            type: String
                        },

                        /**
                         * A regular expression that the value is checked against.
                         * The pattern must match the entire value, not just some subset.
                         */
                        pattern: {
                            type: String
                        },

                        /**
                        * Type of input.
                        */
                        type: {
                            type: String
                        },

                        /**
                         * A hint to the user of what can be entered in the control.
                         */
                        placeholder: {
                            type: String
                        },

                        /**
                         * This attribute indicates that the user cannot modify the value of the control.
                         */
                        readonly: {
                            type: Boolean
                        },

                        /**
                         * Specifies that the user must fill in a value.
                         */
                        required: {
                            type: Boolean
                        },

                        /**
                         * Message to show to the user when validation fails.
                         */
                        rows: {
                            type: String
                        },
                        /**
                        * Message to show to the user when validation fails.
                        */
                        cols: {
                            type: String
                        },
                        /**
                        * Message to show to the user when validation fails.
                        */
                        title: {
                            type: String
                        },

                        /**
                         * The initial value of the control.
                         * It can be used for two-way data binding.
                         */
                        value: {
                            type: String,
                            value: '',
                            observer: '_valueChanged',
                            notify: true
                        },

                        /**
                         * This property is set to true when the control value is invalid.
                         */
                        invalid: {
                            type: Boolean,
                            reflectToAttribute: true,
                            notify: true,
                            value: false
                        },

                        /**
                         * A read-only property indicating whether this input has a non empty value.
                         * It can be used for example in styling of the component.
                         */
                        hasValue: {
                            type: Boolean,
                            value: false,
                            notify: true,
                            readOnly: true,
                            reflectToAttribute: true
                        },

                        /**
                         * When set to true, user is prevented from typing a value that
                         * conflicts with the given `pattern`.
                         */
                        preventInvalidInput: {
                            type: Boolean
                        },

                        _labelId: {
                            type: String
                        },

                        _errorId: {
                            type: String
                        }
                    };
                }

                get focusElement() {
                    return this.root.querySelector('[part=value]');
                }

                _onInput(e) {
                    if (this.preventInvalidInput) {
                        const input = this.focusElement;
                        if (input.value.length > 0 && !this.checkValidity()) {
                            input.value = this.value || '';
                        }
                    }
                }

                _valueChanged(newVal, oldVal) {
                    // setting initial value to empty string, skip validation
                    if (newVal === '' && oldVal === undefined) {
                        return;
                    }
                    if (this.invalid) {
                        this.validate();
                    }
                    this._setHasValue(newVal !== '' && newVal != null);
                }

                /**
                 * Returns true if `value` is valid.
                 * `<iron-form>` uses this to check the validity or all its elements.
                 *
                 * @return {boolean} True if the value is valid.
                 */
                validate() {
                    return !(this.invalid = !this.checkValidity());
                }

                _getActiveErrorId(invalid, errorMessage, errorId) {
                    return errorMessage && invalid ? errorId : undefined;
                }

                _getActiveLabelId(label, labelId) {
                    return label ? labelId : undefined;
                }

                /**
                 * Returns true if the current input value satisfies all constraints (if any)
                 */
                checkValidity() {
                    if (this.required || this.pattern || this.maxlength || this.minlength) {
                        return this.focusElement.checkValidity();
                    } else {
                        return !this.invalid;
                    }
                }

                ready() {
                    super.ready();
                    if (!(window.ShadyCSS && window.ShadyCSS.nativeCss)) {
                        this.updateStyles();
                    }

                    var uniqueId = TextFieldElement._uniqueId = 1 + TextFieldElement._uniqueId || 0;
                    this._errorId = `${this.constructor.is}-error-${uniqueId}`;
                    this._labelId = `${this.constructor.is}-label-${uniqueId}`;
                }

                attributeChangedCallback(prop, oldVal, newVal) {
                    super.attributeChangedCallback(prop, oldVal, newVal);
                    // Needed until Edge has CSS Custom Properties (present in Edge Preview)
                    if (!(window.ShadyCSS && window.ShadyCSS.nativeCss) &&
                        /^(focused|focus-ring|invalid|disabled|placeholder|has-value)$/.test(prop)) {
                        this.updateStyles();
                    }

                    // Safari has an issue with repainting shadow root element styles when a host attribute changes.
                    // Need this workaround (toggle any inline css property on and off) until the issue gets fixed.
                    const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
                    if (isSafari && this.root) {
                        const WEBKIT_PROPERTY = '-webkit-backface-visibility';
                        this.root.querySelectorAll('*').forEach(el => {
                            el.style[WEBKIT_PROPERTY] = 'visible';
                            el.style[WEBKIT_PROPERTY] = '';
                        });
                    }
                }
            }

            customElements.define(TextFieldElement.is, TextFieldElement);

            /**
             * @namespace Vaadin
             */
            window.Vaadin = window.Vaadin || {};
            Vaadin.TextFieldElement = TextFieldElement;
        })();
    </script>
</dom-module>
