
<link rel="import" href="/lib/vaadin-themable-mixin/vaadin-themable-mixin.html" />
<link rel="import" href="/lib/vaadin-grid/vaadin-grid.html" />
<link rel="import" href="/lib/vaadin-grid/vaadin-grid-sorter.html" />
<link rel="import" href="/lib/vaadin-grid/vaadin-grid-sort-behavior.html" />
<link rel="import" href="/lib/vaadin-grid/vaadin-grid-filter.html" />
<link rel="import" href="/lib/vaadin-grid/vaadin-grid-filter-behavior.html" />
<link rel="import" href="/lib/vaadin-date-picker/vaadin-date-picker.html" />
<link rel="import" href="/lib/iron-form/iron-form.html" />
<link rel="import" href="/lib/paper-input/paper-input.html" />
<link rel="import" href="/lib/paper-checkbox-master/paper-checkbox.html" />
<link rel="import" href="/lib/paper-button/paper-button.html" />
<link rel="import" href="/lib/datetime-picker-master/date-picker.html" />

<!--start ColumnToggle-->
<link rel="import" href="/lib/iron-menu-behavior/iron-menubar-behavior.html" />
<link rel="import" href="/lib/paper-tabs-master/paper-tabs.html" />
<link rel="import" href="/lib/iron-icons/iron-icons.html" />
<link rel="import" href="/lib/iron-behaviors/iron-button-state.html" />
<link rel="import" href="/lib/paper-menu-button/paper-menu-button.html" />
<!--end ColumnToggle-->

<dom-module id="x-pedidospagamentolist">
    <template>
        <link rel="stylesheet" href="/lib/bootstrap/dist/css/bootstrap.css" />
        <link rel="stylesheet" href="/lib/font-awesome-4.7.0/css/font-awesome.min.css" />
        <link rel="stylesheet" href="/css/main.css" />
        <custom-style>
            <style is="custom-style">
                input[readonly] {
                    border: 2px solid transparent;
                }

                input {
                    font: inherit;
                }

                .grid {
                    font-size: 13px;
                }

                    .grid input {
                        border: none;
                        padding-left: 5px;
                    }

                paper-input {
                    max-width: 200px !important;
                }
            </style>
        </custom-style>

        <iron-ajax url="/Encomendas/GetListPedidosPagamento"
                   last-response="{{result}}"
                   method="post"
                   handle-as="json"
                   id="grid_databound_ajax"
                   content-type="application/json"></iron-ajax>

        <iron-ajax url="/Encomendas/ExportToExcel_PedidosPagamento"
                   last-response="{{export}}"
                   id="ajax_Export"
                   method="post"
                   handle-as="json"
                   on-response="_exportEXCELResponse"
                   content-type="application/json">
        </iron-ajax>

        <div class="subMenu">
            <paper-button id="btnExport" class="tablinks" on-tap="_exportEXCEL" title="Exportar para Excel"><i class="fa fa-file-excel-o" aria-hidden="true"></i>&nbsp; Exportar</paper-button>

            <!--start ColumnToggle-->
            <paper-menu-button class="column-toggle" no-animations>
                <paper-icon-button icon="view-column" slot="dropdown-trigger" alt="Colunas"></paper-icon-button>
                <div class="list-group" slot="dropdown-content">
                    <template is="dom-repeat" items="[[ _toArray(_columns)]]" id="columnsList">
                        <a href="javascript:void(0);" on-tap="_toggleColumn" data-item$="[[item]]" class$="list-group-item [[ _getColumnItemClass( item.key ) ]]">
                            {{ item.value.label }}
                        </a>
                        <hr />
                    </template>
                </div>
            </paper-menu-button>
            <!--end ColumnToggle-->
        </div>

        <vaadin-grid aria-label="CustomersGrid" id="grid" items="[[result]]" class="grid" active-item="{{activeItem}}" multi-sort="true">
            <vaadin-grid-column width="150px" resizable hidden$="{{ _columns.noPedido.hidden }}">
                <template class="header">
                    <vaadin-grid-sorter path="noPedido">Nº Pedido</vaadin-grid-sorter>
                    <vaadin-grid-filter path="noPedido" />
                </template>
                <template>
                    <div style="text-align:right">
                        {{item.noPedido}}
                    </div>
                </template>
            </vaadin-grid-column>

            <vaadin-grid-column width="150px" resizable hidden$="{{ _columns.dataText.hidden }}">
                <template class="header">
                    <vaadin-grid-sorter path="dataText">Data</vaadin-grid-sorter>
                    <vaadin-grid-filter path="dataText" />
                </template>
                <template>
                    <div style="text-align:right">
                        {{item.dataText}}
                    </div>
                </template>
            </vaadin-grid-column>

            <vaadin-grid-column width="150px" resizable hidden$="{{ _columns.estadoText.hidden }}">
                <template class="header">
                    <vaadin-grid-sorter path="estadoText">Estado</vaadin-grid-sorter>
                    <vaadin-grid-filter path="estadoText" />
                </template>
                <template>
                    {{item.estadoText}}
                </template>
            </vaadin-grid-column>

            <vaadin-grid-column width="150px" resizable hidden$="{{ _columns.noEncomenda.hidden }}">
                <template class="header">
                    <vaadin-grid-sorter path="noEncomenda">Nº Encomenda</vaadin-grid-sorter>
                    <vaadin-grid-filter path="noEncomenda" />
                </template>
                <template>
                    {{item.noEncomenda}}
                </template>
            </vaadin-grid-column>

            <vaadin-grid-column width="150px" resizable hidden$="{{ _columns.codigoFornecedor.hidden }}">
                <template class="header">
                    <vaadin-grid-sorter path="codigoFornecedor">Cód. Fornecedor</vaadin-grid-sorter>
                    <vaadin-grid-filter path="codigoFornecedor" />
                </template>
                <template>
                    {{item.codigoFornecedor}}
                </template>
            </vaadin-grid-column>

            <vaadin-grid-column width="150px" resizable hidden$="{{ _columns.fornecedor.hidden }}">
                <template class="header">
                    <vaadin-grid-sorter path="fornecedor">Fornecedor</vaadin-grid-sorter>
                    <vaadin-grid-filter path="fornecedor" />
                </template>
                <template>
                    {{item.fornecedor}}
                </template>
            </vaadin-grid-column>

            <vaadin-grid-column width="150px" resizable hidden$="{{ _columns.tipoText.hidden }}">
                <template class="header">
                    <vaadin-grid-sorter path="tipoText">Tipo</vaadin-grid-sorter>
                    <vaadin-grid-filter path="tipoText" />
                </template>
                <template>
                    {{item.tipoText}}
                </template>
            </vaadin-grid-column>

            <vaadin-grid-column width="150px" resizable hidden$="{{ _columns.nib.hidden }}">
                <template class="header">
                    <vaadin-grid-sorter path="nib">NIB</vaadin-grid-sorter>
                    <vaadin-grid-filter path="nib" />
                </template>
                <template>
                    {{item.nib}}
                </template>
            </vaadin-grid-column>

            <vaadin-grid-column width="150px" resizable hidden$="{{ _columns.iban.hidden }}">
                <template class="header">
                    <vaadin-grid-sorter path="iban">IBAN</vaadin-grid-sorter>
                    <vaadin-grid-filter path="iban" />
                </template>
                <template>
                    {{item.iban}}
                </template>
            </vaadin-grid-column>

            <vaadin-grid-column width="150px" resizable hidden$="{{ _columns.descricao.hidden }}">
                <template class="header">
                    <vaadin-grid-sorter path="descricao">Descrição</vaadin-grid-sorter>
                    <vaadin-grid-filter path="descricao" />
                </template>
                <template>
                    {{item.descricao}}
                </template>
            </vaadin-grid-column>

            <vaadin-grid-column width="150px" resizable hidden$="{{ _columns.valorEncomenda.hidden }}">
                <template class="header">
                    <vaadin-grid-sorter path="valorEncomenda">Valor da Encomenda</vaadin-grid-sorter>
                    <vaadin-grid-filter path="valorEncomenda" />
                </template>
                <template>
                    <div style="text-align:right">
                        {{item.valorEncomenda}} €
                    </div>
                </template>
            </vaadin-grid-column>

            <vaadin-grid-column width="150px" resizable hidden$="{{ _columns.valor.hidden }}">
                <template class="header">
                    <vaadin-grid-sorter path="valor">Valor do Pedido</vaadin-grid-sorter>
                    <vaadin-grid-filter path="valor" />
                </template>
                <template>
                    <div style="text-align:right">
                        {{item.valor}} €
                    </div>
                </template>
            </vaadin-grid-column>

            <vaadin-grid-column width="150px" resizable hidden$="{{ _columns.prioritarioText.hidden }}">
                <template class="header">
                    <vaadin-grid-sorter path="prioritarioText">Prioritário</vaadin-grid-sorter>
                    <vaadin-grid-filter path="prioritarioText" />
                </template>
                <template>
                    {{item.prioritarioText}}
                </template>
            </vaadin-grid-column>

            <vaadin-grid-column width="150px" resizable hidden$="{{ _columns.aprovadores.hidden }}">
                <template class="header">
                    <vaadin-grid-sorter path="aprovadores">Aprovadores</vaadin-grid-sorter>
                    <vaadin-grid-filter path="aprovadores" />
                </template>
                <template>
                    {{item.aprovadores}}
                </template>
            </vaadin-grid-column>

            <vaadin-grid-column width="150px" resizable hidden$="{{ _columns.numeroTransferencia.hidden }}">
                <template class="header">
                    <vaadin-grid-sorter path="numeroTransferencia">Nº Transferência</vaadin-grid-sorter>
                    <vaadin-grid-filter path="numeroTransferencia" />
                </template>
                <template>
                    {{item.numeroTransferencia}}
                </template>
            </vaadin-grid-column>

            <vaadin-grid-column width="150px" resizable hidden$="{{ _columns.dataEnvioAprovacaoText.hidden }}">
                <template class="header">
                    <vaadin-grid-sorter path="dataEnvioAprovacaoText">Data de Envio para Aprovação</vaadin-grid-sorter>
                    <vaadin-grid-filter path="dataEnvioAprovacaoText" />
                </template>
                <template>
                    <div style="text-align:right">
                        {{item.dataEnvioAprovacaoText}}
                    </div>
                </template>
            </vaadin-grid-column>

            <vaadin-grid-column width="150px" resizable hidden$="{{ _columns.dataPrioridadeText.hidden }}">
                <template class="header">
                    <vaadin-grid-sorter path="dataPrioridadeText">Data da Prioridade</vaadin-grid-sorter>
                    <vaadin-grid-filter path="dataPrioridadeText" />
                </template>
                <template>
                    <div style="text-align:right">
                        {{item.dataPrioridadeText}}
                    </div>
                </template>
            </vaadin-grid-column>

            <vaadin-grid-column width="150px" resizable hidden$="{{ _columns.motivoAnulacao.hidden }}">
                <template class="header">
                    <vaadin-grid-sorter path="motivoAnulacao">Motivo da Anulação</vaadin-grid-sorter>
                    <vaadin-grid-filter path="motivoAnulacao" />
                </template>
                <template>
                    {{item.motivoAnulacao}}
                </template>
            </vaadin-grid-column>

            <vaadin-grid-column width="150px" resizable hidden$="{{ _columns.aprovadoText.hidden }}">
                <template class="header">
                    <vaadin-grid-sorter path="aprovadoText">Aprovado</vaadin-grid-sorter>
                    <vaadin-grid-filter path="aprovadoText" />
                </template>
                <template>
                    {{item.aprovadoText}}
                </template>
            </vaadin-grid-column>

            <vaadin-grid-column width="150px" resizable hidden$="{{ _columns.bloqueadoFaltaPagamentoText.hidden }}">
                <template class="header">
                    <vaadin-grid-sorter path="bloqueadoFaltaPagamentoText">Bloqueado por Falta de Pagamento</vaadin-grid-sorter>
                    <vaadin-grid-filter path="bloqueadoFaltaPagamentoText" />
                </template>
                <template>
                    {{item.bloqueadoFaltaPagamentoText}}
                </template>
            </vaadin-grid-column>

            <vaadin-grid-column width="150px" resizable hidden$="{{ _columns.resolvidoText.hidden }}">
                <template class="header">
                    <vaadin-grid-sorter path="resolvidoText">Resolvido</vaadin-grid-sorter>
                    <vaadin-grid-filter path="resolvidoText" />
                </template>
                <template>
                    {{item.resolvidoText}}
                </template>
            </vaadin-grid-column>

            <vaadin-grid-column width="150px" resizable hidden$="{{ _columns.arquivadoText.hidden }}">
                <template class="header">
                    <vaadin-grid-sorter path="arquivadoText">Arquivado</vaadin-grid-sorter>
                    <vaadin-grid-filter path="arquivadoText" />
                </template>
                <template>
                    {{item.arquivadoText}}
                </template>
            </vaadin-grid-column>

            <vaadin-grid-column width="150px" resizable hidden$="{{ _columns.userPedido.hidden }}">
                <template class="header">
                    <vaadin-grid-sorter path="userPedido">Utilizador do Pedido</vaadin-grid-sorter>
                    <vaadin-grid-filter path="userPedido" />
                </template>
                <template>
                    {{item.userPedido}}
                </template>
            </vaadin-grid-column>

            <vaadin-grid-column width="150px" resizable hidden$="{{ _columns.dataPedidoText.hidden }}">
                <template class="header">
                    <vaadin-grid-sorter path="dataPedidoText">Data do Pedido</vaadin-grid-sorter>
                    <vaadin-grid-filter path="dataPedidoText" />
                </template>
                <template>
                    <div style="text-align:right">
                        {{item.dataPedidoText}}
                    </div>
                </template>
            </vaadin-grid-column>

            <vaadin-grid-column width="150px" resizable hidden$="{{ _columns.userAprovacao.hidden }}">
                <template class="header">
                    <vaadin-grid-sorter path="userAprovacao">Utilizador da Aprovação</vaadin-grid-sorter>
                    <vaadin-grid-filter path="userAprovacao" />
                </template>
                <template>
                    {{item.userAprovacao}}
                </template>
            </vaadin-grid-column>

            <vaadin-grid-column width="150px" resizable hidden$="{{ _columns.dataAprovacaoText.hidden }}">
                <template class="header">
                    <vaadin-grid-sorter path="dataAprovacaoText">Data da Aprovação</vaadin-grid-sorter>
                    <vaadin-grid-filter path="dataAprovacaoText" />
                </template>
                <template>
                    {{item.dataAprovacaoText}}
                </template>
            </vaadin-grid-column>

            <vaadin-grid-column width="150px" resizable hidden$="{{ _columns.userFinanceiros.hidden }}">
                <template class="header">
                    <vaadin-grid-sorter path="userFinanceiros">Utilizador da Disponibilização</vaadin-grid-sorter>
                    <vaadin-grid-filter path="userFinanceiros" />
                </template>
                <template>
                    {{item.userFinanceiros}}
                </template>
            </vaadin-grid-column>

            <vaadin-grid-column width="150px" resizable hidden$="{{ _columns.dataDisponibilizacaoText.hidden }}">
                <template class="header">
                    <vaadin-grid-sorter path="dataDisponibilizacaoText">Data da Disponibilização</vaadin-grid-sorter>
                    <vaadin-grid-filter path="dataDisponibilizacaoText" />
                </template>
                <template>
                    <div style="text-align:right">
                        {{item.dataDisponibilizacaoText}}
                    </div>
                </template>
            </vaadin-grid-column>

            <vaadin-grid-column width="150px" resizable hidden$="{{ _columns.userValidacao.hidden }}">
                <template class="header">
                    <vaadin-grid-sorter path="userValidacao">Utilizador da Validação</vaadin-grid-sorter>
                    <vaadin-grid-filter path="userValidacao" />
                </template>
                <template>
                    {{item.userValidacao}}
                </template>
            </vaadin-grid-column>

            <vaadin-grid-column width="150px" resizable hidden$="{{ _columns.dataValidacaoText.hidden }}">
                <template class="header">
                    <vaadin-grid-sorter path="dataValidacaoText">Data de Validação</vaadin-grid-sorter>
                    <vaadin-grid-filter path="dataValidacaoText" />
                </template>
                <template>
                    <div style="text-align:right">
                        {{item.dataValidacaoText}}
                    </div>
                </template>
            </vaadin-grid-column>

            <vaadin-grid-column width="150px" resizable hidden$="{{ _columns.userArquivo.hidden }}">
                <template class="header">
                    <vaadin-grid-sorter path="userArquivo">Utilizador do Arquivo</vaadin-grid-sorter>
                    <vaadin-grid-filter path="userArquivo" />
                </template>
                <template>
                    {{item.userArquivo}}
                </template>
            </vaadin-grid-column>

            <vaadin-grid-column width="150px" resizable hidden$="{{ _columns.dataArquivoText.hidden }}">
                <template class="header">
                    <vaadin-grid-sorter path="dataArquivoText">Data do Arquivo</vaadin-grid-sorter>
                    <vaadin-grid-filter path="dataArquivoText" />
                </template>
                <template>
                    <div style="text-align:right">
                        {{item.dataArquivoText}}
                    </div>
                </template>
            </vaadin-grid-column>
        </vaadin-grid>
    </template>

    <script>
        document.addEventListener('WebComponentsReady', function () {
            Polymer({
                is: 'x-pedidospagamentolist',
                properties: {
                    _permissions: {
                        type: Array
                    },
                    activeItem: {
                        observer: '_rowSelected'
                    },
                    _areaid: {
                        type: Number,
                        notify: true,
                        value: 0
                    },
                    _columns: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    }
                },

                _rowSelected: function (item) {
                    if (item != null) {
                        window.location.href = "/Encomendas/PedidoPagamento_Details/" + item.noPedido;
                    }
                },

                ready: function () {

                    this.$.grid_databound_ajax.generateRequest();

                    /*ColumnToggle*/
                    this._startColumnToggle();

                    var _this = this;
                    var gridToBottomTimeout;
                    $(window).resize(function () {
                        clearTimeout(gridToBottomTimeout);
                        gridToBottomTimeout = setTimeout(function () { _this.fixGridToBottom(); }, 200);
                    });
                    $(window).trigger('resize');
                },

                fixGridToBottom: function () {
                    var grid_el = $(this.$.grid);
                    var parentHeight = $(this).offsetParent().height();
                    var windowHeight = $(window).height();
                    var paddingTop = $(this).offsetParent().css('padding-top').replace("px", "");
                    var offsetTop = $(this).offset().top;
                    var height = windowHeight - offsetTop - paddingTop;
                    $(this.$.grid).height(height);
                },

                _exportEXCEL: function () {
                    //debugger;
                    var payload = { list: this.result, columns: this._columns };
                    console.log(payload);

                    this.$.ajax_Export.body = JSON.stringify(payload);
                    this.$.ajax_Export.generateRequest();
                },
                _exportEXCELResponse: function (e) {
                    //debugger
                    var FileName = this.export;
                    location.href = '../Encomendas/ExportToExcel?fileName=' + FileName;
                },

                /*start - ColumnToggle*/
                _startColumnToggle: function () {
                    var columns = {
                        "noPedido": { hidden: false, label: "Nº Pedido" },
                        "dataText": { hidden: false, label: "Data" },
                        "estadoText": { hidden: false, label: "Estado" },
                        "noEncomenda": { hidden: false, label: "Nº Encomenda" },
                        "codigoFornecedor": { hidden: false, label: "Cód. Fornecedor" },
                        "fornecedor": { hidden: false, label: "Fornecedor" },
                        "tipoText": { hidden: false, label: "Tipo" },
                        "nib": { hidden: false, label: "NIB" },
                        "iban": { hidden: false, label: "IBAN" },
                        "descricao": { hidden: false, label: "Descrição" },
                        "valorEncomenda": { hidden: false, label: "Valor da Encomenda" },
                        "valor": { hidden: false, label: "Valor do Pedido" },
                        "prioritarioText": { hidden: false, label: "Prioritário" },
                        "aprovadores": { hidden: false, label: "Aprovadores" },
                        "numeroTransferencia": { hidden: false, label: "Nº Transferência" },
                        "dataEnvioAprovacaoText": { hidden: false, label: "Data de Envio para Aprovação" },
                        "dataPrioridadeText": { hidden: false, label: "Data da Prioridade" },
                        "motivoAnulacao": { hidden: false, label: "Motivo da Anulação" },
                        "aprovadoText": { hidden: false, label: "Aprovado" },
                        "bloqueadoFaltaPagamentoText": { hidden: false, label: "Bloqueado por Falta de Pagamento" },
                        "resolvidoText": { hidden: false, label: "Resolvido" },
                        "arquivadoText": { hidden: false, label: "Arquivado" },
                        "userPedido": { hidden: false, label: "Utilizador do Pedido" },
                        "dataPedidoText": { hidden: false, label: "Data do Pedido" },
                        "userAprovacao": { hidden: false, label: "Utilizador da Aprovação" },
                        "dataAprovacaoText": { hidden: false, label: "Data da Aprovação" },
                        "userFinanceiros": { hidden: false, label: "Utilizador da Disponibilização" },
                        "dataDisponibilizacaoText": { hidden: false, label: "Data da Disponibilização" },
                        "userValidacao": { hidden: false, label: "Utilizador da Validação" },
                        "dataValidacaoText": { hidden: false, label: "Data de Validação" },
                        "userArquivo": { hidden: false, label: "Utilizador do Arquivo" },
                        "dataArquivoText": { hidden: false, label: "Data do Arquivo" }
                    };

                    if (localStorage["pedidospagamentolist.ToggleColumn"]) {
                        var keys = Object.keys(columns);
                        var storedColumns = JSON.parse(localStorage["pedidospagamentolist.ToggleColumn"]);
                        for (var i = 0; i < keys.length; i++) {
                            columns[keys[i]] = storedColumns[keys[i]];
                        }
                    };
                    this._columns = columns;
                },

                _toggleColumn: function (event) {
                    var columnIndex = JSON.parse(event.target.dataset.item).key;
                    event.path[0].classList.toggle("selected");
                    this.set('_columns.' + columnIndex + '.hidden', (!this._columns[columnIndex].hidden));
                    if (typeof (Storage) !== "undefined") {
                        localStorage["pedidospagamentolist.ToggleColumn"] = JSON.stringify(this._columns);
                    }
                },

                _getColumnItemClass: function (columnIndex) {
                    return !this._columns[columnIndex].hidden ? "selected" : "";
                },

                _toArray: function (obj) {
                    return Object.keys(obj).map(function (key) {
                        return {
                            key: key,
                            value: obj[key]
                        };
                    });
                },

                _formatBoolValue: function (value) {
                    return value ? "Sim" : "Não";
                }
                /* end - ColumnToggle */
            });
        });
    </script>

</dom-module>