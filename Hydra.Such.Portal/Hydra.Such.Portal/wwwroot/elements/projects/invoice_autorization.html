
<link rel="import" href="/lib/vaadin-themable-mixin/vaadin-themable-mixin.html" />
<link rel="import" href="/lib/vaadin-grid/vaadin-grid.html" />
<link rel="import" href="/lib/vaadin-grid/vaadin-grid-sorter.html" />
<link rel="import" href="/lib/vaadin-grid/vaadin-grid-sort-behavior.html" />
<link rel="import" href="/lib/vaadin-grid/vaadin-grid-filter.html" />
<link rel="import" href="/lib/vaadin-grid/vaadin-grid-filter-behavior.html" />
<link rel="import" href="/lib/vaadin-grid/vaadin-grid-selection-column.html" />
<link rel="import" href="/lib/vaadin-grid/vaadin-grid-active-item-behavior.html" />
<link rel="import" href="/lib/vaadin-grid/vaadin-grid-selection-behavior.html" />
<link rel="import" href="/lib/vaadin-date-picker/vaadin-date-picker.html" />
<link rel="import" href="/lib/iron-form/iron-form.html" />
<link rel="import" href="/lib/paper-input/paper-input.html" />
<link rel="import" href="/lib/paper-checkbox-master/paper-checkbox.html" />
<link rel="import" href="/lib/vaadin-combo-box/vaadin-combo-box.html" />
<link rel="import" href="/lib/paper-button/paper-button.html" />
<link rel="import" href="/lib/paper-toast-master/paper-toast.html" />

<!--<h1 class="title">Autorização Faturação</h1>-->

<dom-module id="x-invoice-autorization">
<template>
<link rel="stylesheet" href="/lib/bootstrap/dist/css/bootstrap.css" />
<link rel="stylesheet" href="/lib/font-awesome-4.7.0/css/font-awesome.min.css" />
<link rel="stylesheet" href="/css/main.css" />

<custom-style>
    <style is="custom-style">
        input[readonly] {
            border: 2px solid transparent;
        }

        input {
            font: inherit;
        }

        paper-input {
            max-width: 450px !important;
        }
    </style>
</custom-style>

<iron-ajax url="/Projetos/GetAutorizacaoFaturacao"
           last-response="{{result}}"
           method="post"
           auto
           handle-as="json"
           id="page_databound_ajax"
           content-type="application/json">
</iron-ajax>
<iron-ajax url="/Projetos/CreateInvoiceLines"
           last-response="{{lines}}"
           method="post"
           handle-as="json"
           id="page_createlines_ajax"
           on-response="_CreateLinesResponse"
           content-type="application/json">
</iron-ajax>


<iron-ajax url="/PopulateDropdowns/GetProjectDiaryMovements"
           last-response="{{response2}}"
           auto
           method="post"
           handle-as="json"
           content-type="application/json"></iron-ajax>

<iron-ajax url="/PopulateDropdowns/GetProjectDiaryTypes"
           last-response="{{response3}}"
           auto
           method="post"
           handle-as="json"
           content-type="application/json"></iron-ajax>

<div class="row">
    <div class="col-lg-2 col-md-2 col-sm-4 col-xs-12">
        <h2 class="separator">Autorização Faturação</h2>
    </div>
</div>
<div class="row">
    <div class="col-lg-2 col-md-2 col-sm-4 col-xs-12">
        <paper-button raised id="btnConfirm" class="btnSave" on-tap="_confirm">Faturar</paper-button>
    </div>
</div>

<br />
<vaadin-grid id="projectInvoiceAutorization" selected-items={{selectedItems}} active-item="{{selectedItem}}" aria-label="Tabela Autorização Faturação" items="[[result]]" class="editGrid">
    <vaadin-grid-selection-column auto-select>
    </vaadin-grid-selection-column>

    <vaadin-grid-column width="15%">
        <template class="header">
            <vaadin-grid-sorter path="projectNo">Nº Projeto</vaadin-grid-sorter>
            <vaadin-grid-filter path="projectNo" />
        </template>
        <template>
            {{item.projectNo}}
        </template>
    </vaadin-grid-column>

    <vaadin-grid-column width="15%">
        <template class="header">
            <vaadin-grid-sorter path="invoiceToClientNo">Fatura-a Nº Cliente</vaadin-grid-sorter>
            <vaadin-grid-filter path="invoiceToClientNo" />
        </template>
        <template>
            {{item.invoiceToClientNo}}
        </template>
    </vaadin-grid-column>

    <vaadin-grid-column width="15%">
        <template class="header">
            <vaadin-grid-sorter path="clientName">Nome Cliente</vaadin-grid-sorter>
            <vaadin-grid-filter path="clientName" />
        </template>
        <template>
            {{item.clientName}}
        </template>
    </vaadin-grid-column>
            
    <vaadin-grid-column width="15%">
        <template class="header">
            <vaadin-grid-sorter path="date">Data</vaadin-grid-sorter>
            <vaadin-grid-filter path="date" />
        </template>
        <template>
            {{item.date}}
        </template>
    </vaadin-grid-column>
    <vaadin-grid-column width="15%">
        <template class="header">
            <vaadin-grid-sorter path="movementType">Tipo Movimento</vaadin-grid-sorter>
            <vaadin-grid-filter path="movementType" />
        </template>
        <template>
            <vaadin-combo-box items="[[response2]]" item-value-path="id" item-label-path="value" value="{{item.movementType}}" disabled>
                <template>
                    <paper-icon-item>
                        <paper-item-body two-line>
                            <div>[[item.value]]</div>
                        </paper-item-body>
                    </paper-icon-item>
                </template>
            </vaadin-combo-box>
        </template>
    </vaadin-grid-column>
    <vaadin-grid-column width="15%">
        <template class="header">
            <vaadin-grid-sorter path="type">Tipo</vaadin-grid-sorter>
            <vaadin-grid-filter path="type" />
        </template>
        <template>
            <vaadin-combo-box id="type[[index]]" items="[[response3]]" item-value-path="id" item-label-path="value" value="{{item.type}}" disabled>
                <template>
                    <paper-icon-item>
                        <paper-item-body two-line>
                            <div>[[item.value]]</div>
                        </paper-item-body>
                    </paper-icon-item>
                </template>
            </vaadin-combo-box>
        </template>
    </vaadin-grid-column>
    <vaadin-grid-column width="15%">
        <template class="header">
            <vaadin-grid-sorter path="code">Código</vaadin-grid-sorter>
            <vaadin-grid-filter path="code" />
        </template>
        <template>
            {{item.code}}
        </template>
    </vaadin-grid-column>
    <vaadin-grid-column width="15%">
        <template class="header">
            <vaadin-grid-sorter path="description">Descrição</vaadin-grid-sorter>
            <vaadin-grid-filter path="description" />
        </template>
        <template>
            {{item.description}}
        </template>
    </vaadin-grid-column>
    <vaadin-grid-column width="15%">
        <template class="header">
            <vaadin-grid-sorter path="quantity">Quantidade</vaadin-grid-sorter>
            <vaadin-grid-filter path="quantity" />
        </template>
        <template>
            {{item.quantity}}
        </template>
    </vaadin-grid-column>
    <vaadin-grid-column width="15%">
        <template class="header">
            <vaadin-grid-sorter path="measurementUnitCode">Cód. Unidade Medida</vaadin-grid-sorter>
            <vaadin-grid-filter path="measurementUnitCode" />
        </template>
        <template>
            {{item.measurementUnitCode}}
        </template>
    </vaadin-grid-column>
    <vaadin-grid-column width="15%">
        <template class="header">
            <vaadin-grid-sorter path="locationCode">Cód. Localização</vaadin-grid-sorter>
            <vaadin-grid-filter path="locationCode" />
        </template>
        <template>
            {{item.locationCode}}
        </template>
    </vaadin-grid-column>
    <vaadin-grid-column width="15%">
        <template class="header">
            <vaadin-grid-sorter path="regionCode">Código Região</vaadin-grid-sorter>
            <vaadin-grid-filter path="regionCode" />
        </template>
        <template>
            {{item.regionCode}}
        </template>
    </vaadin-grid-column>
    <vaadin-grid-column width="15%">
        <template class="header">
            <vaadin-grid-sorter path="functionalAreaCode">Código Área</vaadin-grid-sorter>
            <vaadin-grid-filter path="functionalAreaCode" />
        </template>
        <template>
            {{item.functionalAreaCode}}
        </template>
    </vaadin-grid-column>
    <vaadin-grid-column width="15%">
        <template class="header">
            <vaadin-grid-sorter path="responsabilityCenterCode">Código Centro Responsabilidade</vaadin-grid-sorter>
            <vaadin-grid-filter path="responsabilityCenterCode" />
        </template>
        <template>
            {{item.responsabilityCenterCode}}
        </template>
    </vaadin-grid-column>
    <vaadin-grid-column width="15%">
        <template class="header">
            <vaadin-grid-sorter path="unitCost">Custo Unitário</vaadin-grid-sorter>
            <vaadin-grid-filter path="unitCost" />
        </template>
        <template>
            <span slot="suffix">{{item.unitCost}}€</span>
        </template>
    </vaadin-grid-column>
    <vaadin-grid-column width="15%">
        <template class="header">
            <vaadin-grid-sorter path="totalCost">Custo Total</vaadin-grid-sorter>
            <vaadin-grid-filter path="totalCost" />
        </template>
        <template>
            <span slot="suffix">{{item.totalCost}}€</span>
        </template>
    </vaadin-grid-column>
    <vaadin-grid-column width="15%">
        <template class="header">
            <vaadin-grid-sorter path="unitPrice">Preço Unitário</vaadin-grid-sorter>
            <vaadin-grid-filter path="unitPrice" />
        </template>
        <template>
            <span slot="suffix">{{item.unitPrice}}€</span>
        </template>
    </vaadin-grid-column>
    <vaadin-grid-column width="15%">
        <template class="header">
            <vaadin-grid-sorter path="totalPrice">Preço Total</vaadin-grid-sorter>
            <vaadin-grid-filter path="totalPrice" />
        </template>
        <template>
            <span slot="suffix">{{item.totalPrice}}€</span>
        </template>
    </vaadin-grid-column>
    <vaadin-grid-column width="15%">
        <template class="header">
            <vaadin-grid-sorter path="commitmentNumber">Nº Compromisso</vaadin-grid-sorter>
            <vaadin-grid-filter path="commitmentNumber" />
        </template>
        <template>
            {{item.commitmentNumber}}
        </template>
    </vaadin-grid-column>
</vaadin-grid>
<paper-toast id="ToastMessage" duration="4000" horizontalAlign="right"></paper-toast>
<paper-toast id="ToastError" style="background-color:red" duration="4000" horizontalAlign="right"></paper-toast>
</template>
    

<script>
    document.addEventListener('WebComponentsReady', function () {
        Polymer({
            is: 'x-invoice-autorization',
            properties: {
                ddCGTOM_Type: {
                    type: Number,
                    notify: true,
                    value: ""
                },

                ddCGTOM_FailType: {
                    type: Number,
                    notify: true,
                    value: ""
                },

                selectedItem: {
                    type: Array,
                },

                selectedItems: {
                    type: Array,
                }
            },
            ready: function () {
                //this.$.page_databound_ajax.generateRequest();
            },
            openToast: function (message) {
                debugger;
                this.$.ToastMessage.text = message;
                this.$.ToastMessage.open();
            },
                 
            _confirm: function (selectedItem, selectedItems) {
                debugger;
                this.$.page_createlines_ajax.body = JSON.stringify(this.selectedItems);
                this.$.page_createlines_ajax.generateRequest();
                //console.log(this.selectedItems);
            },

            _CreateLinesResponse: function (e) {
                debugger;
                var message = this.lines.eReasonCode;
                debugger;
                switch (message) {
                         
                case 1: this.$.ToastMessage.text = 'Faturas criadas com sucesso';
                    this.$.ToastMessage.open();
                    break;
                case 2: this.$.ToastError.text = 'Ocorreu um erro ao criar Linhas de Fatura no NAV';
                    this.$.ToastError.open();
                    break;
                case 3: this.$.ToastError.text = 'Ocorreu um erro ao criar o Cabeçalho das Faturas no NAV.';
                    this.$.ToastError.open();
                    break;
                case 4: this.$.ToastError.text = 'Ocorreu um erro ao criar Pré Fatura';
                    this.$.ToastError.open();
                }
                     
                this.$.page_databound_ajax.generateRequest();
                this.$.ToastMessage.text = 'Faturas criadas com sucesso';
                this.$.ToastMessage.open();
            }
        });
    });
</script>
</dom-module>