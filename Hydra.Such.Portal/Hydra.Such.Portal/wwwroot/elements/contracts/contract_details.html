
<link rel="import" href="/lib/paper-tabs-master/paper-tab.html" />
<link rel="import" href="/lib/paper-tabs-master/paper-tabs.html" />
<link rel="import" href="/lib/iron-pages-master/iron-pages.html" />
<link rel="import" href="/lib/iron-menu-behavior/iron-menubar-behavior.html" />
<link rel="import" href="/lib/iron-form/iron-form.html" />
<link rel="import" href="/lib/paper-input/paper-input.html" />
<link rel="import" href="/lib/paper-checkbox-master/paper-checkbox.html" />
<link rel="import" href="/lib/paper-button/paper-button.html" />
<link rel="import" href="/lib/vaadin-combo-box/vaadin-combo-box.html" />
<link rel="import" href="/lib/paper-input/paper-input.html" />
<link rel="import" href="/lib/paper-button/paper-button.html" />
<link rel="import" href="/lib/paper-toast-master/paper-toast.html" />
<link rel="import" href="/lib/vaadin-date-picker/vaadin-date-picker.html">
<link rel="import" href="/lib/vaadin-material-theme/vaadin-date-picker.html">
<link rel="import" href="/lib/vaadin-grid/vaadin-grid.html">







<dom-module id="x-contractdetails">
    <template>
        <!-- STYLES -->
        <link rel="stylesheet" href="/lib/bootstrap/dist/css/bootstrap.css" />
        <link rel="stylesheet" href="/lib/font-awesome-4.7.0/css/font-awesome.min.css" />
        <link rel="stylesheet" href="/css/main.css" />
        <style>
            vaadin-combo-box {
                padding: 1px 0 !important;
            }

            vaadin-date-picker {
                margin-top: -14px;
                width: 100%;
                padding-top: 0px;
            }

            .break_clear {
                margin-top: 15px;
                margin-right: 0px !important;
                margin-left: 0px !important;
            }

            .break_frm {
                margin-top: 15px;
            }

            .col-cust-req {
                width: 11.1% !important;
            }
        </style>


        <!-- DROPDOWNS POPULATE -->
        <iron-ajax url="/PopulateDropdowns/GetFeeUnits" last-response="{{CBFeeUnits}}" auto method="post" handle-as="json" content-type="application/json"></iron-ajax>
        <iron-ajax url="/PopulateDropdowns/GetResponsabilityCenterCode" last-response="{{CBResponsabilityCenterCodes}}" auto method="post" handle-as="json" content-type="application/json"></iron-ajax>
        <iron-ajax url="/PopulateDropdowns/GetPaymentTerms" last-response="{{CBPaymentTerms}}" auto method="post" handle-as="json" content-type="application/json"></iron-ajax>
        <iron-ajax url="/PopulateDropdowns/GetRegionCode" last-response="{{CBRegions}}" auto method="post" handle-as="json" content-type="application/json"></iron-ajax>
        <iron-ajax url="/PopulateDropdowns/GetAllClients" last-response="{{CBClients}}" auto method="post" handle-as="json" content-type="application/json" id="clients_ajax"></iron-ajax>
        <iron-ajax url="/PopulateDropdowns/GetFunctionalAreaCode" last-response="{{CBFunctionalAreas}}" auto method="post" handle-as="json" content-type="application/json"></iron-ajax>
        <iron-ajax url="/PopulateDropdowns/GetContractStatus" last-response="{{CBStatus}}" auto method="post" handle-as="json" content-type="application/json"></iron-ajax>
        <iron-ajax url="/PopulateDropdowns/GetContractChangeStatus" last-response="{{CBChangeStatus}}" auto method="post" handle-as="json" content-type="application/json"></iron-ajax>
        <iron-ajax url="/PopulateDropdowns/GetServiceObjects" last-response="{{CBServiceObjects}}" auto method="post" handle-as="json" content-type="application/json"></iron-ajax>
        <iron-ajax url="/PopulateDropdowns/GetContractBillingTypes" last-response="{{CBBillingTypes}}" auto method="post" handle-as="json" content-type="application/json"></iron-ajax>
        <iron-ajax url="/PopulateDropdowns/GetContractMaintenanceTypes" last-response="{{CBMaintenanceTypes}}" auto method="post" handle-as="json" content-type="application/json"></iron-ajax>
        <iron-ajax url="/PopulateDropdowns/GetContractInvoicePeriods" last-response="{{CBInvoicePeriods}}" auto method="post" handle-as="json" content-type="application/json"></iron-ajax>
        <iron-ajax url="/PopulateDropdowns/GetNAVShippingAddresses" last-response="{{CBShippingAddresses}}" auto method="post" handle-as="json" content-type="application/json" id="shippinhAddress_ajax"></iron-ajax>
        <iron-ajax url="/PopulateDropdowns/GetProjectList" last-response="{{CBProjects}}" auto method="post" handle-as="json" content-type="application/json"></iron-ajax>
        <iron-ajax url="/PopulateDropdowns/GetContractInvoiceGroups" last-response="{{CBInvoiceGroups}}" auto method="post" handle-as="json" content-type="application/json"></iron-ajax>

        
        

        <!-- PROJECT CRUDS -->
        <iron-ajax url="/Contratos/GetContractDetails"
                   last-response="{{data}}"
                   method="post"
                   handle-as="json"
                   id="page_databound_ajax"
                   on-response="_responseProcessor"
                   content-type="application/json"></iron-ajax>

        <iron-ajax url="/Contratos/DeleteContract"
                   last-response="{{deletedData}}"
                   method="post"
                   handle-as="json"
                   id="ajax_delete_project"
                   on-response="_responseDeleteProcessor"
                   content-type="application/json"></iron-ajax>

        <!-- PROJECT Valitador -->
        <iron-ajax url="/Contratos/ValidateNumeration"
                   last-response="{{validateResponse}}"
                   method="post"
                   handle-as="json"
                   id="page_validator_ajax"
                   on-response="_responseValidatorProcessor"
                   content-type="application/json"></iron-ajax>

        <!-- Address databound -->
        <iron-ajax url="/Projetos/GetAddressData"
                   last-response="{{addressData}}"
                   method="post"
                   handle-as="json"
                   id="address_ajax"
                   on-response="_addressResponseProcessor"
                   content-type="application/json"></iron-ajax>

        <paper-tabs fit-container no-slide autoselect autoselect-delay="0" selected="{{selected}}">
            <paper-tab>Geral</paper-tab>
            <paper-tab>Faturação</paper-tab>
            <paper-tab>Envio</paper-tab>
            <paper-tab>Detalhes Fatura</paper-tab>
        </paper-tabs>
        <iron-pages selected="{{selected}}">
            <!--Geral-->
            <div>
                <div class="row break_clear">
                    <div class="col-lg-3">
                        <paper-input type="text" value="{{data.contractNo}}" id="contractNo" name="contractNo" label="Nº Contrato"> </paper-input>
                    </div>
                    <div class="col-lg-3">
                        <vaadin-combo-box items="[[CBFeeUnits]]" item-value-path="id" item-label-path="value" value="{{data.provisionUnit}}" label="Unidade Prestação">
                            <template>
                                <paper-icon-item>
                                    <paper-item-body two-line>
                                        <div>[[item.value]]</div>
                                    </paper-item-body>
                                </paper-icon-item>
                            </template>
                        </vaadin-combo-box>
                    </div>
                    <div class="col-lg-3">
                        <vaadin-combo-box items="[[CBResponsabilityCenterCodes]]" item-value-path="id" item-label-path="value" value="{{data.codeResponsabilityCenter}}" label="Cód. Centro Responsabilidade">
                            <template>
                                <paper-icon-item>
                                    <paper-item-body two-line>
                                        <div>[[item.value]]</div>
                                    </paper-item-body>
                                </paper-icon-item>
                            </template>
                        </vaadin-combo-box>
                    </div>
                    <div class="col-lg-3">
                        <vaadin-combo-box items="[[CBPaymentTerms]]" item-value-path="id" item-label-path="value" value="{{data.codePaymentTerms}}" label="Cód. Termos Pagamento">
                            <template>
                                <paper-icon-item>
                                    <paper-item-body two-line>
                                        <div>[[item.value]]</div>
                                    </paper-item-body>
                                </paper-icon-item>
                            </template>
                        </vaadin-combo-box>
                    </div>
                </div>
                
                <div class="row break_clear">
                    <div class="col-lg-3">
                        <paper-input type="text" value="{{data.description}}" id="Description" name="Description" label="Descrição"> </paper-input>
                    </div>
                    <div class="col-lg-3">
                        <vaadin-combo-box items="[[CBRegions]]" item-value-path="id" item-label-path="value" value="{{data.codeRegion}}" label="Cód. Região">
                            <template>
                                <paper-icon-item>
                                    <paper-item-body two-line>
                                        <div>[[item.value]]</div>
                                    </paper-item-body>
                                </paper-icon-item>
                            </template>
                        </vaadin-combo-box>
                    </div>
                    <div class="col-lg-3">
                        <paper-input type="text" value="{{data.notes}}" id="notes" name="notes" label="Notas"> </paper-input>
                    </div>
                    <div class="col-lg-3">
                        <vaadin-date-picker label="Data Inicio 1º Contrato" id="startDateFirstContract" name="startDateFirstContract" value="{{data.startDateFirstContract}}"></vaadin-date-picker>
                    </div>
                </div>

                <div class="row break_clear">
                    <div class="col-lg-3">
                        <vaadin-combo-box items="[[CBClients]]" item-value-path="id" item-label-path="value" value="{{data.clientNo}}" label="Nº Cliente">
                            <template>
                                <paper-icon-item>
                                    <paper-item-body two-line>
                                        <div>[[item.value]]</div>
                                    </paper-item-body>
                                </paper-icon-item>
                            </template>
                        </vaadin-combo-box>
                    </div>
                    <div class="col-lg-3">
                        <vaadin-combo-box items="[[CBFunctionalAreas]]" item-value-path="id" item-label-path="value" value="{{data.codeFunctionalArea}}" label="Cód. Centro Responsabilidade">
                            <template>
                                <paper-icon-item>
                                    <paper-item-body two-line>
                                        <div>[[item.value]]</div>
                                    </paper-item-body>
                                </paper-icon-item>
                            </template>
                        </vaadin-combo-box>
                    </div>
                    <div class="col-lg-3">
                        <paper-input type="text" value="{{data.proposalNo}}" id="proposalNo" name="proposalNo" label="Nº Proposta" readonly> </paper-input>
                    </div>
                    <div class="col-lg-3">
                        <paper-input type="text" value="{{data.firstContractReference}}" id="firstContractReference" name="firstContractReference" label="Referência 1º Contrato"> </paper-input>
                    </div>
                </div>

                <div class="row break_clear">
                    <div class="panel panel-default">
                        <div class="panel-heading">Versão Atual do Contrato</div>
                        <div class="panel-body">
                            <div class="row break_clear">
                                <div class="col-lg-3">
                                    <paper-input type="text" value="{{data.clientRequisitionNo}}" id="clientRequisitionNo" name="clientRequisitionNo" label="Nº Requisição do Cliente"> </paper-input>
                                </div>
                                <div class="col-lg-3">
                                    <paper-input type="text" value="{{data.promiseNo}}" id="promiseNo" name="promiseNo" label="Nº Compromisso"> </paper-input>
                                </div>
                                <div class="col-lg-3">
                                    <vaadin-date-picker label="Data Inicial" id="startDate" name="startDate" value="{{data.startDate}}"></vaadin-date-picker>
                                </div>
                                <div class="col-lg-3">
                                    <vaadin-combo-box items="[[CBStatus]]" item-value-path="id" item-label-path="value" value="{{data.status}}" label="Estado">
                                        <template>
                                            <paper-icon-item>
                                                <paper-item-body two-line>
                                                    <div>[[item.value]]</div>
                                                </paper-item-body>
                                            </paper-icon-item>
                                        </template>
                                    </vaadin-combo-box>
                                </div>
                            </div>
                            <div class="row break_clear">
                                <div class="col-lg-3">
                                    <vaadin-date-picker label="Data Receção Requisição" id="receiptDateRequisition" name="receiptDateRequisition" value="{{data.receiptDateRequisition}}"></vaadin-date-picker>
                                </div>
                                <div class="col-lg-3">
                                    <paper-input type="number" value="{{data.versionNo}}" id="versionNo" name="versionNo" label="Nº Versão" readonly> </paper-input>
                                </div>
                                <div class="col-lg-3">
                                    <vaadin-date-picker label="Data Expiração" id="dueDate" name="dueDate" value="{{data.dueDate}}"></vaadin-date-picker>
                                </div>
                                <div class="col-lg-3">
                                    <vaadin-combo-box items="[[CBChangeStatus]]" item-value-path="id" item-label-path="value" value="{{data.changeStatus}}" label="Estado Alteração">
                                        <template>
                                            <paper-icon-item>
                                                <paper-item-body two-line>
                                                    <div>[[item.value]]</div>
                                                </paper-item-body>
                                            </paper-icon-item>
                                        </template>
                                    </vaadin-combo-box>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!--Faturação-->
            <div>
                <div class="row break_clear">
                    <div class="col-lg-3">
                        <vaadin-combo-box items="[[CBServiceObjects]]" item-value-path="id" item-label-path="value" value="{{data.serviceObject}}" label="Objeto Serviço">
                            <template>
                                <paper-icon-item>
                                    <paper-item-body two-line>
                                        <div>[[item.value]]</div>
                                    </paper-item-body>
                                </paper-icon-item>
                            </template>
                        </vaadin-combo-box>
                    </div>
                </div>
                <div class="row break_clear">
                    <div class="panel panel-default">
                        <div class="panel-heading">Requisições Cliente</div>
                        <div class="panel-body">
                            <div class="row">
                                <div class="col-lg-2">
                                    <vaadin-date-picker label="Inicio Compromisso" id="_CRStartDate" name="_CRStartDate" value="{{_CRStartDate}}"></vaadin-date-picker>
                                </div>
                                <div class="col-lg-2">
                                    <vaadin-date-picker label="Fim Compromisso" id="_CREndDate" name="_CREndDate" value="{{_CREndDate}}"></vaadin-date-picker>
                                </div>
                                <div class="col-lg-2">
                                    <paper-input type="number" value="{{_CRRequisitionNo}}" id="_CRRequisitionNo" name="_CRRequisitionNo" label="Nº Requisição Cliente"> </paper-input>
                                </div>
                                <div class="col-lg-2">
                                    <vaadin-date-picker label="Data Requisição" id="_CRRequisitionDate" name="_CRRequisitionDate" value="{{_CRRequisitionDate}}"></vaadin-date-picker>
                                </div>
                                <div class="col-lg-2">
                                    <paper-input type="number" value="{{_CRPromiseNo}}" id="_CRPromiseNo" name="_CRPromiseNo" label="Nº Compromisso"> </paper-input>
                                </div>
                                <div class="col-lg-2">
                                    <vaadin-combo-box items="[[CBInvoiceGroups]]" id="_CRInvoiceGroup" name="_CRInvoiceGroup" item-value-path="id" item-label-path="value" value="{{_CRInvoiceGroup}}" label="Grupo Fatura">
                                        <template>
                                            <paper-icon-item>
                                                <paper-item-body two-line>
                                                    <div>[[item.value]]</div>
                                                </paper-item-body>
                                            </paper-icon-item>
                                        </template>
                                    </vaadin-combo-box>
                                </div>
                            </div>
                            <div class="row break_frm">
                                <div class="col-lg-2">
                                    <vaadin-combo-box items="[[CBProjects]]" item-value-path="id" item-label-path="value" id="_CRProjectNo" name="_CRProjectNo" value="{{_CRProjectNo}}" label="Nº Projeto">
                                        <template>
                                            <paper-icon-item>
                                                <paper-item-body two-line>
                                                    <div>[[item.value]]</div>
                                                </paper-item-body>
                                            </paper-icon-item>
                                        </template>
                                    </vaadin-combo-box>
                                </div>
                                <div class="col-lg-2">
                                    <vaadin-date-picker label="Data Última Fatura" id="_CRLastInvoiceDate" name="_CRLastInvoiceDate" value="{{_CRLastInvoiceDate}}"></vaadin-date-picker>
                                </div>
                                <div class="col-lg-1">
                                    <paper-button class="btnSave" raised on-tap="_createClientRequisition">Criar</paper-button>
                                </div>
                            </div>
                            <!-- VAADIN GRID  Requisições Cliente -->
                            <vaadin-grid aria-label="ClientRequisitions" id="grid_ClientRequisitions" items="[[data.clientRequisitions]]" class="grid" multi-sort="true">
                                <vaadin-grid-column>
                                    <template class="header">
                                        <vaadin-grid-sorter path="startDate">Inicio Compromisso</vaadin-grid-sorter>
                                        <vaadin-grid-filter path="startDate" />
                                    </template>
                                    <template>
                                        {{item.startDate}}
                                    </template>
                                </vaadin-grid-column>
                                <vaadin-grid-column>
                                    <template class="header">
                                        <vaadin-grid-sorter path="endDate">Fim Compromisso</vaadin-grid-sorter>
                                        <vaadin-grid-filter path="endDate" />
                                    </template>
                                    <template>
                                        {{item.endDate}}
                                    </template>
                                </vaadin-grid-column>
                                <vaadin-grid-column>
                                    <template class="header">
                                        <vaadin-grid-sorter path="clientRequisitionNo">Nº Requisição Cliente</vaadin-grid-sorter>
                                        <vaadin-grid-filter path="clientRequisitionNo" />
                                    </template>
                                    <template>
                                        {{item.clientRequisitionNo}}
                                    </template>
                                </vaadin-grid-column>
                                <vaadin-grid-column>
                                    <template class="header">
                                        <vaadin-grid-sorter path="requisitionDate">Data Requisição</vaadin-grid-sorter>
                                        <vaadin-grid-filter path="requisitionDate" />
                                    </template>
                                    <template>
                                        {{item.requisitionDate}}
                                    </template>
                                </vaadin-grid-column>
                                <vaadin-grid-column>
                                    <template class="header">
                                        <vaadin-grid-sorter path="promiseNo">Nº Compromisso</vaadin-grid-sorter>
                                        <vaadin-grid-filter path="promiseNo" />
                                    </template>
                                    <template>
                                        {{item.promiseNo}}
                                    </template>
                                </vaadin-grid-column>
                                <vaadin-grid-column>
                                    <template class="header">
                                        <vaadin-grid-sorter path="invoiceGroup">Grupo Fatura</vaadin-grid-sorter>
                                        <vaadin-grid-filter path="invoiceGroup" />
                                    </template>
                                    <template>
                                        {{item.invoiceGroup}}
                                    </template>
                                </vaadin-grid-column>
                                <vaadin-grid-column>
                                    <template class="header">
                                        <vaadin-grid-sorter path="projectNo">Nº Projeto</vaadin-grid-sorter>
                                        <vaadin-grid-filter path="projectNo" />
                                    </template>
                                    <template>
                                        {{item.projectNo}}
                                    </template>
                                </vaadin-grid-column>
                                <vaadin-grid-column>
                                    <template class="header">
                                        <vaadin-grid-sorter path="lastInvoiceDate">Data Última Fatura</vaadin-grid-sorter>
                                        <vaadin-grid-filter path="lastInvoiceDate" />
                                    </template>
                                    <template>
                                        {{item.lastInvoiceDate}}
                                    </template>
                                </vaadin-grid-column>
                                <vaadin-grid-column>
                                    <template class="header">
                                    </template>
                                    <template>
                                        <center>
                                            <paper-button class="btnRemove" raised on-tap="_deleteClientRequisition">Eliminar</paper-button>
                                        </center>
                                    </template>
                                </vaadin-grid-column>
                            </vaadin-grid>
                        </div>
                    </div>
                </div>
            </div>

            <!--Envio-->
            <div>
                <div class="row break_clear">
                    <div class="col-lg-3">
                        <vaadin-combo-box items="[[CBShippingAddresses]]" item-value-path="id" item-label-path="value" value="{{data.codeShippingAddress}}" label="Cód. Endereço Envio" on-value-changed="_getAddressByCode">
                            <template>
                                <paper-icon-item>
                                    <paper-item-body two-line>
                                        <div>[[item.value]]</div>
                                    </paper-item-body>
                                </paper-icon-item>
                            </template>
                        </vaadin-combo-box>

                    </div>
                    <div class="col-lg-3">
                        <paper-input type="text" value="{{data.shippingAddress}}" id="ShippingAddress" name="ShippingAddress" required label="Envio-a Endereço"></paper-input>

                    </div>
                    <div class="col-lg-3">
                        <paper-input type="text" value="{{data.shippingLocality}}" id="ShippingLocality" name="ShippingLocality" required label="Envio-a Localidade"> </paper-input>
                    </div>
                    <div class="col-lg-3">
                        <paper-input type="text" value="{{data.shippingZipCode}}" id="shippingZipCode" name="shippingZipCode" required label="Envio-a Cód. Postal"> </paper-input>
                    </div>
                </div>
                <div class="row break_clear">
                    <div class="col-lg-3">
                        <paper-input type="text" value="{{data.shippingName}}" id="ShippingName" name="ShippingName" required label="Envio-a Nome"> </paper-input>
                    </div>
                </div>
            </div>

            <!--Detalhes Fatura-->
            <div>
                <div class="row break_clear">
                    <div class="col-lg-3">
                        <vaadin-combo-box items="[[CBBillingTypes]]" item-value-path="id" item-label-path="value" value="{{data.billingType}}" label="Tipo Faturação">
                            <template>
                                <paper-icon-item>
                                    <paper-item-body two-line>
                                        <div>[[item.value]]</div>
                                    </paper-item-body>
                                </paper-icon-item>
                            </template>
                        </vaadin-combo-box>
                    </div>
                    <div class="col-lg-3">
                        <paper-input type="number" value="{{data.mc}}" id="mc" name="mc" label="% MC"> </paper-input>
                    </div>
                    <div class="col-lg-3">
                        <paper-checkbox checked="{{data.fixedVowsAgreement}}">Contrato Avença Fixa</paper-checkbox>
                    </div>
                    <div class="col-lg-3">
                        <paper-checkbox checked="{{data.batchInvoices}}">Juntar Faturas</paper-checkbox>
                    </div>
                </div>
                <div class="row break_clear">
                    <div class="col-lg-3">
                        <vaadin-combo-box items="[[CBMaintenanceTypes]]" item-value-path="id" item-label-path="value" value="{{data.maintenanceContractType}}" label="Tipo Contrato Manut.">
                            <template>
                                <paper-icon-item>
                                    <paper-item-body two-line>
                                        <div>[[item.value]]</div>
                                    </paper-item-body>
                                </paper-icon-item>
                            </template>
                        </vaadin-combo-box>
                    </div>
                    <div class="col-lg-3">
                        <paper-input type="text" value="{{data.displacementFee}}" auto-validate pattern="^-?(?:\d+|\d{1,3}(?:,\d{3})+)(?:(\.|,)\d+)?$" error-message="Valor inválido" id="displacementFee"  name="displacementFee" label="Taxa Deslocação"> </paper-input>
                    </div>
                    <div class="col-lg-3">
                        <paper-checkbox checked="{{data.variableAvengeAgrement}}">Contrato Avença Variável</paper-checkbox>
                    </div>
                    <div class="col-lg-3">
                        <paper-checkbox checked="{{data.contractLinesInBilling}}">Linhas Contrato em Fact.</paper-checkbox>
                    </div>
                </div>
                <div class="row break_clear">
                    <div class="col-lg-3">
                        <paper-input type="text" value="{{data.provisioningFee}}" auto-validate pattern="^-?(?:\d+|\d{1,3}(?:,\d{3})+)(?:(\.|,)\d+)?$" error-message="Valor inválido" id="provisioningFee" name="provisioningFee" label="Taxa Aprovisionamento"> </paper-input>
                    </div>
                    <div class="col-lg-3">
                        <vaadin-combo-box items="[[CBInvoicePeriods]]" item-value-path="id" item-label-path="value" value="{{data.invocePeriod}}" label="Período Fatura">
                            <template>
                                <paper-icon-item>
                                    <paper-item-body two-line>
                                        <div>[[item.value]]</div>
                                    </paper-item-body>
                                </paper-icon-item>
                            </template>
                        </vaadin-combo-box>
                    </div>
                </div>
                <div class="row break_clear">
                    <div class="panel panel-default">
                        <div class="panel-heading">Textos Fatura</div>
                        <div class="panel-body">
                            <div class="row">
                                <div class="col-lg-3">
                                    <vaadin-combo-box items="[[CBInvoiceGroups]]" id="_CRInvoiceGroup" name="_IRInvoiceGroup" item-value-path="id" item-label-path="value" value="{{_IRInvoiceGroup}}" label="Grupo Fatura">
                                        <template>
                                            <paper-icon-item>
                                                <paper-item-body two-line>
                                                    <div>[[item.value]]</div>
                                                </paper-item-body>
                                            </paper-icon-item>
                                        </template>
                                    </vaadin-combo-box>
                                </div>
                                <div class="col-lg-3">
                                    <vaadin-combo-box items="[[CBProjects]]" item-value-path="id" item-label-path="value" id="_IRProjectNo" name="_IRProjectNo" value="{{_IRProjectNo}}" label="Nº Projeto">
                                        <template>
                                            <paper-icon-item>
                                                <paper-item-body two-line>
                                                    <div>[[item.value]]</div>
                                                </paper-item-body>
                                            </paper-icon-item>
                                        </template>
                                    </vaadin-combo-box>
                                </div>
                                <div class="col-lg-3">
                                    <paper-input type="text" value="{{_IRInvoiceText}}" id="_IRInvoiceText" name="_IRInvoiceText" label="Texto Fatura"> </paper-input>
                                </div>
                                <div class="col-lg-1">
                                    <paper-button class="btnSave" raised on-tap="_createInvoiceText">Criar</paper-button>
                                </div>
                            </div>

                            <!-- VAADIN GRID  Textos Fatura -->
                            <vaadin-grid aria-label="InvoiceTexts" id="grid_invoiceTexts" items="[[data.invoiceTexts]]" class="grid" multi-sort="true">
                                <vaadin-grid-column>
                                    <template class="header">
                                        <vaadin-grid-sorter path="invoiceGroup">Grupo Fatura</vaadin-grid-sorter>
                                        <vaadin-grid-filter path="invoiceGroup" />
                                    </template>
                                    <template>
                                        {{item.invoiceGroup}}
                                    </template>
                                </vaadin-grid-column>
                                <vaadin-grid-column>
                                    <template class="header">
                                        <vaadin-grid-sorter path="projectNo">Nº Projeto</vaadin-grid-sorter>
                                        <vaadin-grid-filter path="projectNo" />
                                    </template>
                                    <template>
                                        {{item.projectNo}}
                                    </template>
                                </vaadin-grid-column>
                                <vaadin-grid-column>
                                    <template class="header">
                                        <vaadin-grid-sorter path="invoiceText">Texto Fatura</vaadin-grid-sorter>
                                        <vaadin-grid-filter path="invoiceText" />
                                    </template>
                                    <template>
                                        {{item.invoiceText}}
                                    </template>
                                </vaadin-grid-column>
                                <vaadin-grid-column>
                                    <template class="header">
                                    </template>
                                    <template>
                                        <center>
                                            <paper-button class="btnRemove" raised on-tap="_deleteInvoiceText">Eliminar</paper-button>
                                        </center>
                                    </template>
                                </vaadin-grid-column>
                            </vaadin-grid>
                        </div>
                    </div>
                </div>
            </div>
        </iron-pages>

        <div class="marginSpace">
            <template is="dom-if" if="{{ _isCreate }}">
                <paper-button raised id="btnCreate" class="btnSave" on-tap="_create"><i class="fa fa-plus" aria-hidden="true"></i>&nbsp; Criar</paper-button>
            </template>
            <template is="dom-if" if="{{ !_isCreate }}">
                <paper-button raised id="btnUpdate" class="btnSave" on-tap="_update"><i class="fa fa-floppy-o" aria-hidden="true"></i>&nbsp; Guardar</paper-button>
                <paper-button raised id="btnCancel" class="btnRemove" on-tap="_delete"><i class="fa fa-undo" aria-hidden="true"></i>&nbsp; Eliminar</paper-button>
            </template>
        </div>

        <paper-toast id="ToastMessage" duration="4000" horizontalAlign="right"></paper-toast>
    </template>

    <script>
        document.addEventListener('WebComponentsReady', function () {
            Polymer({
                is: 'x-contractdetails',
                properties: {
                    _areaid: {
                        type: Number,
                        notify: true,
                        value: 0
                    },
                    _contractno: {
                        type: String,
                        notify: true,
                        value: ""
                    },
                    selected: {
                        type: Number,
                        value: 0
                    },
                    _isCreate: {
                        type: Boolean,
                        value: false
                    },


                    //FORM CLIENT REQUISITIONS
                    _CRStartDate: {
                        type: String,
                        notify: true,
                        value: ""
                    },
                    _CREndDate: {
                        type: String,
                        notify: true,
                        value: ""
                    },
                    _CRRequisitionNo: {
                        type: String,
                        notify: true,
                        value: ""
                    },
                    _CRRequisitionDate: {
                        type: String,
                        notify: true,
                        value: ""
                    },
                    _CRPromiseNo: {
                        type: String,
                        notify: true,
                        value: ""
                    },
                    _CRInvoiceGroup: {
                        type: String,
                        notify: true,
                        value: ""
                    },
                    _CRProjectNo: {
                        type: String,
                        notify: true,
                        value: ""
                    },
                    _CRLastInvoiceDate: {
                        type: String,
                        notify: true,
                        value: ""
                    },


                    //FORM INVOICE TEXTS
                    _IRInvoiceGroup: {
                        type: String,
                        notify: true,
                        value: ""
                    },
                    _IRProjectNo: {
                        type: String,
                        notify: true,
                        value: ""
                    },
                    _IRInvoiceText: {
                        type: String,
                        notify: true,
                        value: ""
                    },
                },
                ready: function () {
                    //GET CONTRACT DATA
                    this.$.page_databound_ajax.body = JSON.stringify({ "ContractNo": this._contractno });
                    this.$.page_databound_ajax.generateRequest();

                    if (this._contractno == "") {
                        this._isCreate = true;
                        //this.data.area = this._areaid;
                    }
                },
                _openToast: function (message) {
                    this.$.ToastMessage.text = message;
                    this.$.ToastMessage.open();
                },
                _validateData: function() {
                    if (false) {
                        this._openToast(validate);
                        return false;
                    }
                    return true;
                },

                //CRUDS
                _create: function () {
                    if (this._validateData()) {
                        this.$.page_validator_ajax.body = JSON.stringify(this.data);
                        this.$.page_validator_ajax.generateRequest();
                    }
                },
                _update: function () {
                    if (this._validateData()) {
                        this._executeRequest("/Contratos/UpdateContract", this.data)
                    }
                },
                _delete: function () {
                    var Contract = this.data;
                    var ajax_request = this.$.ajax_delete_project;
                    bootbox.confirm({
                        message: "Tem a certeza que pretende remover o contrato " + this.data.contractNo + "?",
                        buttons: {
                            confirm: {
                                label: 'Sim',
                                className: 'btn-success'
                            },
                            cancel: {
                                label: 'Não',
                                className: 'btn-danger'
                            }
                        },
                        callback: function (result) {
                            if (result) {
                                ajax_request.body = JSON.stringify(Contract);
                                ajax_request.generateRequest();
                            }
                        }
                    });
                },

                //Responses Processors
                _responseProcessor: function (data) {
                    var self = this;

                    //Set AreaId
                    if (this.data.contractNo == "" || this.data.contractNo == null) {
                        
                        this.data.area = this._areaid;
                        this.$.versionNo.value = "1";
                    }

                    if (data.detail.status === 200) {
                        if (data.detail.url.indexOf("GetProject") !== -1) {
                            if (this.data.contractNo == "") {
                                this._isCreate = true;
                            }
                        } else if (data.detail.url.indexOf("Create") !== -1) {
                            this._createResponseProcessor();
                        } else if (data.detail.url.indexOf("Update") !== -1) {
                            this._openToast("Contrato atualizado com sucesso.")
                        }
                    } else {
                        this._openToast("Ocorreu um erro ao criar o contrato.")
                    }
                },
                _createResponseProcessor: function () {
                    if (this.data.eReasonCode == 1) {
                        this._isCreate = false;
                        this._openToast("Projeto criado com sucesso.");
                    } else {
                        this._openToast(this.data.eMessage);
                    }
                },
                _responseValidatorProcessor: function (data) {
                    var self = this;
                    if (data.detail.status === 200) {
                        if (this.validateResponse == "") {
                            this._executeRequest("/Contratos/CreateContract", this.data)
                        } else {
                            this._openToast(data);
                        }
                    }
                },
                _responseDeleteProcessor: function (data) {
                    var self = this;
                    if (data.detail.status === 200) {
                        if (this.deletedData.eReasonCode == 1) {
                            this._openToast("Não é possivel eliminar o contrato pois este já possui movimentos.");
                        } else {
                            this._openToast(this.deletedData.eMessage);
                            setTimeout(
                                function () {
                                    window.location.replace("/");
                                }, 2500);
                        }
                    }
                },

                //Address Functions
                _getAddressByCode: function (e) {
                    this.$.address_ajax.body = JSON.stringify(e.detail.value);
                    this.$.address_ajax.generateRequest();
                },
                _addressResponseProcessor: function (e) {
                    var self = this;
                    if (this.addressData != null) {
                        //Fill Data
                        this.$.ShippingName.value = this.addressData.name;
                        this.$.ShippingAddress.value = this.addressData.address;
                        this.$.shippingZipCode.value = this.addressData.zipCode;
                        this.$.ShippingLocality.value = this.addressData.city;
                        this.$.ShippingContact.value = this.addressData.contact;
                    }
                },

                //Client Requisition Functions
                _createClientRequisition: function () {
                    
                    this.data.clientRequisitions.unshift({
                        contractNo: this.data.contractNo,
                        startDate: this._CRStartDate,
                        endDate: this._CREndDate,
                        clientRequisitionNo: this._CRRequisitionNo,
                        requisitionDate: this._CRRequisitionDate,
                        promiseNo: this._CRPromiseNo,
                        invoiceGroup: this._CRInvoiceGroup,
                        projectNo: this._CRProjectNo,
                        lastInvoiceDate: this._CRLastInvoiceDate
                    });
                    this.$.grid_ClientRequisitions.clearCache();
                },
                _deleteClientRequisition: function (data) {
                    var index = this.data.clientRequisitions.indexOf(data.model.item);
                    this.data.clientRequisitions.splice(index, 1);

                    this.$.grid_ClientRequisitions.clearCache();
                },

                //Invoice Texts Functions
                _createInvoiceText: function () {
                    this.data.invoiceTexts.unshift({
                        contractNo: this.data.contractNo,
                        invoiceGroup: this._IRInvoiceGroup,
                        projectNo: this._IRProjectNo,
                        invoiceText: this._IRInvoiceText
                    });
                    this.$.grid_invoiceTexts.clearCache();
                },
                _deleteInvoiceText: function (data) {
                    var index = this.data.invoiceTexts.indexOf(data.model.item);
                    this.data.invoiceTexts.splice(index, 1);

                    this.$.grid_invoiceTexts.clearCache();
                },

                //Helpers
                _executeRequest: function (url, data) {
                    this.$.page_databound_ajax.url = url;
                    this.$.page_databound_ajax.body = JSON.stringify(data);
                    this.$.page_databound_ajax.generateRequest();
                }

            });
        });
    </script>

</dom-module>

